#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "post-commit"

# Get the type and message of the last commit in the main repository
LAST_COMMIT=$(git log -1 --pretty=%B)
TYPE=$(echo $LAST_COMMIT | cut -d'(' -f1)
MESSAGE=$(echo $LAST_COMMIT | cut -d')' -f2 | xargs)

# Loop through all submodules and add and commit changes with a custom message
git submodule foreach --recursive "
  SUBMODULE_PATH=\$(echo \$path | sed 's#^libs/##;s#^apps/##');
  if ! git diff --quiet HEAD; then
    git add . && git commit -m \"$TYPE(\$SUBMODULE_PATH)$MESSAGE\" || : && git push;
    echo \"\$toplevel\"
    cd \"\$toplevel\"
    git add \"\$toplevel/\$path\"
    git commit --no-verify -m \"chore\(test-app\): updated git ref \[skip ci\]\"
  fi
"
exit 0
